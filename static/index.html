<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorly Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Same styles as before */
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark {
            background-color: #1f2937;
            color: #fff;
        }

        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            transition: box-shadow 0.2s ease, background-color 0.3s, color 0.3s;
        }

        body.dark .card {
            background-color: #374151;
            color: #fff;
        }

        /* Auth styles */
        #auth {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f9fafb;
            padding: 0 1rem;
        }

        #auth .card {
            max-width: 400px;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        #auth input {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            width: 100%;
            font-size: 1rem;
            outline: none;
            box-sizing: border-box;
        }

        #auth button {
            background-color: #000;
            color: #fff;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #000;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        /* Navbar styles */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: #fff;
            border-bottom: 1px solid #e5e7eb;
        }

        body.dark .navbar {
            background-color: #374151;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-links a {
            margin-left: 1rem;
            text-decoration: none;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
        }

        .nav-links a.active {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }

        /* Chat styles */
        .chat-card {
            display: flex;
            flex-direction: column;
            height: 36rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
            display: flex;
            flex-direction: column;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }

        .chat-message-user {
            background-color: #2563eb;
            color: white;
            padding: 0.75rem;
            border-radius: 1rem;
            margin-left: 2rem;
            align-self: flex-end;
        }

        .chat-message-ai {
            background-color: #f3f4f6;
            color: #111827;
            padding: 0.75rem;
            border-radius: 1rem;
            margin-right: 2rem;
            align-self: flex-start;
        }

        .chat-input-area {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input-area input {
            flex: 1;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            outline: none;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .error-message {
            color: #dc2626;
            background-color: #fef2f2;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
        }

        /* Quick action styles */
        .quick-actions-grid {
            display: grid;
            gap: 0.5rem;
        }

        .quick-action-btn {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .quick-action-btn:hover {
            background-color: #e5e7eb;
        }

        /* Layout styles */
        .ai-tutor-layout {
            display: flex;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .quick-actions-column {
            flex: 1;
        }

        .ai-chat-column {
            flex: 2;
        }

        .secondary-nav {
            display: flex;
            justify-content: center;
            border-bottom: 1px solid #e5e7eb;
            margin-top: 2rem;
        }

        .secondary-nav button {
            background: none;
            border: none;
            padding: 0.5rem 1.5rem;
            cursor: pointer;
            font-weight: 500;
            margin: 0 0.25rem;
            transition: color 0.2s, border-bottom 0.2s;
            color: inherit;
        }

        .secondary-nav button.active-tab {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }

        .main-content {
            padding: 1.5rem;
        }

        /* Button styles */
        .btn-primary {
            background-color: #2563eb;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        /* Form styles */
        input, select {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin: 0.25rem;
        }

        /* Table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background-color: #f9fafb;
            font-weight: 600;
        }

        /* Settings panel */
        .settings-panel {
            background-color: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        body.dark .settings-panel {
            background-color: #374151;
            border-color: #4b5563;
        }

        .api-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .api-status.connected {
            background-color: #dcfce7;
            color: #166534;
        }

        .api-status.disconnected {
            background-color: #fef2f2;
            color: #dc2626;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .ai-tutor-layout {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API Configuration Component
        function APISettings({ apiConfig, setApiConfig }) {
            const [isVisible, setIsVisible] = useState(false);

            const updateConfig = (key, value) => {
                setApiConfig(prev => ({ ...prev, [key]: value }));
                localStorage.setItem('tutorly_api_config', JSON.stringify({ ...apiConfig, [key]: value }));
            };

            return (
                <div className="settings-panel">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                        <h3>API Configuration</h3>
                        <button onClick={() => setIsVisible(!isVisible)} className="btn-primary">
                            {isVisible ? 'Hide' : 'Show'} Settings
                        </button>
                    </div>
                    
                    {isVisible && (
                        <div style={{ display: 'grid', gap: '1rem' }}>
                            <div>
                                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '500' }}>
                                    Gemini API Key:
                                </label>
                                <input
                                    type="password"
                                    value={apiConfig.geminiApiKey}
                                    onChange={(e) => updateConfig('geminiApiKey', e.target.value)}
                                    placeholder="Enter your Gemini API key"
                                    style={{ width: '100%' }}
                                />
                                <small style={{ color: '#6b7280' }}>
                                    Get your API key from: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
                                </small>
                            </div>
                            
                            <div>
                                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '500' }}>
                                    Backend API URL:
                                </label>
                                <input
                                    type="text"
                                    value={apiConfig.backendUrl}
                                    onChange={(e) => updateConfig('backendUrl', e.target.value)}
                                    placeholder="https://your-api.com/api"
                                    style={{ width: '100%' }}
                                />
                                <small style={{ color: '#6b7280' }}>
                                    Your Flask backend API endpoint
                                </small>
                            </div>
                            
                            <div style={{ display: 'flex', gap: '1rem' }}>
                                <span>Gemini Status:</span>
                                <span className={`api-status ${apiConfig.geminiApiKey ? 'connected' : 'disconnected'}`}>
                                    {apiConfig.geminiApiKey ? 'API Key Set' : 'No API Key'}
                                </span>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // API Service for Gemini
        class GeminiService {
            constructor(apiKey) {
                this.apiKey = apiKey;
                this.baseUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';
            }

            async sendMessage(message, conversationHistory = []) {
                if (!this.apiKey) {
                    throw new Error('Gemini API key not configured');
                }

                try {
                    const response = await fetch(`${this.baseUrl}?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [
                                {
                                    parts: [
                                        {
                                            text: `You are Tutorly, a helpful AI tutor assistant. Help students with their academic questions in a friendly and educational way. 

Previous conversation:
${conversationHistory.map(msg => `${msg.sender}: ${msg.text}`).join('\n')}

Student: ${message}

Please provide a helpful response:`
                                        }
                                    ]
                                }
                            ],
                            generationConfig: {
                                temperature: 0.7,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 1024,
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error('Gemini API Error:', error);
                    throw error;
                }
            }
        }

        // Generic API Service for Backend
        class APIService {
            constructor(baseUrl) {
                this.baseUrl = baseUrl;
            }

            async request(endpoint, options = {}) {
                try {
                    const response = await fetch(`${this.baseUrl}${endpoint}`, {
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        },
                        ...options
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            }

            // User Management
            async login(credentials) {
                return this.request('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify(credentials)
                });
            }

            async register(userData) {
                return this.request('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });
            }

            // Todo Operations
            async getTodos(userId) {
                return this.request(`/todos/${userId}`);
            }

            async createTodo(userId, todo) {
                return this.request(`/todos/${userId}`, {
                    method: 'POST',
                    body: JSON.stringify(todo)
                });
            }

            async updateTodo(todoId, updates) {
                return this.request(`/todos/${todoId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updates)
                });
            }

            async deleteTodo(todoId) {
                return this.request(`/todos/${todoId}`, {
                    method: 'DELETE'
                });
            }

            // Assignment Operations
            async getAssignments(userId) {
                return this.request(`/assignments/${userId}`);
            }

            async createAssignment(userId, assignment) {
                return this.request(`/assignments/${userId}`, {
                    method: 'POST',
                    body: JSON.stringify(assignment)
                });
            }

            async updateAssignment(assignmentId, updates) {
                return this.request(`/assignments/${assignmentId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updates)
                });
            }

            async deleteAssignment(assignmentId) {
                return this.request(`/assignments/${assignmentId}`, {
                    method: 'DELETE'
                });
            }

            // Progress/Analytics
            async getProgress(userId) {
                return this.request(`/progress/${userId}`);
            }

            async updateProgress(userId, progressData) {
                return this.request(`/progress/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify(progressData)
                });
            }

            // Chat History
            async getChatHistory(userId) {
                return this.request(`/chat/${userId}`);
            }

            async saveChatMessage(userId, message) {
                return this.request(`/chat/${userId}`, {
                    method: 'POST',
                    body: JSON.stringify(message)
                });
            }
        }

        // Enhanced Chatbot Component with Gemini Integration
        function ChatbotPage({ setLoggedIn, setStudentName, setStudentId, studentId, apiConfig }) {
            const quickActions = [
                'Help me solve this math problem',
                'Explain photosynthesis',
                'Review my essay for grammar',
                'Teach me about the Civil War',
            ];

            const [chatMessages, setChatMessages] = useState([]);
            const [input, setInput] = useState('');
            const [tab, setTab] = useState('ai-tutor');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');

            const geminiService = new GeminiService(apiConfig.geminiApiKey);
            const apiService = new APIService(apiConfig.backendUrl);

            // Load chat history on component mount
            useEffect(() => {
                loadChatHistory();
            }, [studentId]);

            const loadChatHistory = async () => {
                if (!apiConfig.backendUrl || !studentId) return;
                
                try {
                    const history = await apiService.getChatHistory(studentId);
                    setChatMessages(history || []);
                } catch (error) {
                    console.log('No previous chat history found');
                }
            };

            const sendMessage = async () => {
                if (!input.trim() || isLoading) return;

                const userMessage = { sender: 'user', text: input, timestamp: new Date().toISOString() };
                const newMessages = [...chatMessages, userMessage];
                setChatMessages(newMessages);
                setInput('');
                setIsLoading(true);
                setError('');

                try {
                    // Save user message to backend
                    if (apiConfig.backendUrl && studentId) {
                        await apiService.saveChatMessage(studentId, userMessage);
                    }

                    // Get AI response from Gemini
                    if (apiConfig.geminiApiKey) {
                        const aiResponse = await geminiService.sendMessage(input, chatMessages);
                        const aiMessage = { 
                            sender: 'ai', 
                            text: aiResponse, 
                            timestamp: new Date().toISOString() 
                        };
                        
                        setChatMessages(prev => [...prev, aiMessage]);

                        // Save AI message to backend
                        if (apiConfig.backendUrl && studentId) {
                            await apiService.saveChatMessage(studentId, aiMessage);
                        }
                    } else {
                        // Fallback response if no API key
                        const fallbackMessage = {
                            sender: 'ai',
                            text: 'Hi! I need a Gemini API key to help you properly. Please configure your API key in the settings above.',
                            timestamp: new Date().toISOString()
                        };
                        setChatMessages(prev => [...prev, fallbackMessage]);
                    }
                } catch (error) {
                    setError('Failed to get AI response: ' + error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleQuickAction = (action) => {
                setInput(action);
            };

            return (
                <div className="ai-tutor-layout">
                    <div className="quick-actions-column">
                        <div className="card">
                            <h3>Quick Actions</h3>
                            <div className="quick-actions-grid">
                                {quickActions.map((action, i) => (
                                    <button 
                                        key={i} 
                                        className="quick-action-btn"
                                        onClick={() => handleQuickAction(action)}
                                    >
                                        {action}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="ai-chat-column">
                        <div className="card chat-card">
                            <h3>Chat with AI Tutor</h3>
                            
                            {error && (
                                <div className="error-message">
                                    {error}
                                </div>
                            )}
                            
                            <div className="chat-messages">
                                {chatMessages.length === 0 ? (
                                    <div style={{ textAlign: 'center', color: '#6b7280', marginTop: '2rem' }}>
                                        <p>👋 Hi! I'm your AI tutor. How can I help you today?</p>
                                        <p>Try asking me about homework, concepts, or use a quick action!</p>
                                    </div>
                                ) : (
                                    chatMessages.map((msg, i) => (
                                        <div key={i} className={msg.sender === 'user' ? 'chat-message-user' : 'chat-message-ai'}>
                                            {msg.text}
                                        </div>
                                    ))
                                )}
                                
                                {isLoading && (
                                    <div className="chat-message-ai">
                                        <span>🤔 Thinking...</span>
                                    </div>
                                )}
                            </div>
                            
                            <div className={`chat-input-area ${isLoading ? 'loading' : ''}`}>
                                <input
                                    type="text"
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    placeholder="Ask me anything..."
                                    onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                                    disabled={isLoading}
                                />
                                <button 
                                    onClick={sendMessage} 
                                    className="btn-primary"
                                    disabled={isLoading || !input.trim()}
                                >
                                    {isLoading ? '...' : 'Send'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Enhanced Todo Component with API Integration
        function TodoList({ studentId, apiConfig }) {
            const [tasks, setTasks] = useState([]);
            const [input, setInput] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [filter, setFilter] = useState('all');
            const [isLoading, setIsLoading] = useState(false);

            const apiService = new APIService(apiConfig.backendUrl);

            useEffect(() => {
                loadTodos();
            }, [studentId]);

            const loadTodos = async () => {
                if (!apiConfig.backendUrl || !studentId) {
                    // Load from localStorage as fallback
                    const savedTodos = localStorage.getItem(`todos_${studentId}`);
                    if (savedTodos) {
                        setTasks(JSON.parse(savedTodos));
                    }
                    return;
                }

                try {
                    setIsLoading(true);
                    const todos = await apiService.getTodos(studentId);
                    setTasks(todos);
                } catch (error) {
                    console.error('Failed to load todos:', error);
                    // Fallback to localStorage
                    const savedTodos = localStorage.getItem(`todos_${studentId}`);
                    if (savedTodos) {
                        setTasks(JSON.parse(savedTodos));
                    }
                } finally {
                    setIsLoading(false);
                }
            };

            const saveTodos = (newTasks) => {
                // Save to localStorage as backup
                localStorage.setItem(`todos_${studentId}`, JSON.stringify(newTasks));
                setTasks(newTasks);
            };

            const addTask = async () => {
                if (!input.trim() || isLoading) return;

                const newTask = { 
                    text: input, 
                    done: false, 
                    id: Date.now(),
                    createdAt: new Date().toISOString()
                };

                try {
                    if (apiConfig.backendUrl && studentId) {
                        const savedTask = await apiService.createTodo(studentId, newTask);
                        saveTodos([...tasks, savedTask]);
                    } else {
                        saveTodos([...tasks, newTask]);
                    }
                    setInput('');
                } catch (error) {
                    console.error('Failed to add todo:', error);
                    // Add locally anyway
                    saveTodos([...tasks, newTask]);
                    setInput('');
                }
            };

            const toggleDone = async (index) => {
                const task = tasks[index];
                const updatedTask = { ...task, done: !task.done };
                const newTasks = [...tasks];
                newTasks[index] = updatedTask;

                try {
                    if (apiConfig.backendUrl && task.id) {
                        await apiService.updateTodo(task.id, { done: updatedTask.done });
                    }
                    saveTodos(newTasks);
                } catch (error) {
                    console.error('Failed to update todo:', error);
                    saveTodos(newTasks);
                }
            };

            const deleteTask = async (index) => {
                const task = tasks[index];
                
                try {
                    if (apiConfig.backendUrl && task.id) {
                        await apiService.deleteTodo(task.id);
                    }
                    const newTasks = tasks.filter((_, i) => i !== index);
                    saveTodos(newTasks);
                } catch (error) {
                    console.error('Failed to delete todo:', error);
                    const newTasks = tasks.filter((_, i) => i !== index);
                    saveTodos(newTasks);
                }
            };

            const filteredTasks = tasks.filter((t) => {
                const matchesSearch = t.text.toLowerCase().includes(searchQuery.toLowerCase());
                if (filter === 'pending') return matchesSearch && !t.done;
                if (filter === 'done') return matchesSearch && t.done;
                return matchesSearch;
            });

            return (
                <div style={{ padding: '1.5rem' }}>
                    <h2>Todo List {isLoading && <span style={{ fontSize: '0.8em', color: '#6b7280' }}>Loading...</span>}</h2>

                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                        <input
                            type="text"
                            placeholder="New task..."
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            style={{ flex: 1 }}
                            onKeyPress={(e) => e.key === 'Enter' && addTask()}
                        />
                        <button onClick={addTask} className="btn-primary" disabled={isLoading}>
                            Add
                        </button>
                    </div>

                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                        <input
                            type="text"
                            placeholder="Search..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            style={{ flex: 1 }}
                        />
                        <select value={filter} onChange={(e) => setFilter(e.target.value)}>
                            <option value="all">All</option>
                            <option value="pending">Pending</option>
                            <option value="done">Done</option>
                        </select>
                    </div>

                    {filteredTasks.length === 0 ? (
                        <p style={{ color: '#6b7280' }}>No tasks found.</p>
                    ) : (
                        filteredTasks.map((t, i) => (
                            <div key={t.id || i} style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                justifyContent: 'space-between',
                                backgroundColor: 'white',
                                padding: '0.75rem',
                                borderRadius: '0.5rem',
                                marginBottom: '0.5rem',
                                boxShadow: '0 1px 2px rgba(0,0,0,0.05)'
                            }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                    <input
                                        type="checkbox"
                                        checked={t.done}
                                        onChange={() => toggleDone(i)}
                                    />
                                    <span style={{ 
                                        textDecoration: t.done ? 'line-through' : 'none', 
                                        color: t.done ? '#6b7280' : 'inherit' 
                                    }}>
                                        {t.text}
                                    </span>
                                </div>
                                <button
                                    onClick={() => deleteTask(i)}
                                    style={{ color: '#dc2626', background: 'none', border: 'none', cursor: 'pointer' }}
                                >
                                    Delete
                                </button>
                            </div>
                        ))
                    )}
                </div>
            );
        }

        // Simple Auth Component (enhanced to work with API)
        function Auth({ setStudentName, setStudentId, setLoggedIn, apiConfig }) {
            const [name, setName] = useState('');
            const [id, setId] = useState('');
            const [msg, setMsg] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const apiService = new APIService(apiConfig.backendUrl);

            const login = async () => {
                if (!name || !id) {
                    setMsg('Please enter both Student Name and Student ID.');
                    return;
                }

                setIsLoading(true);
                try {
                    if (apiConfig.backendUrl) {
                        // Try to authenticate with backend
                        const response = await apiService.login({ name, studentId: id });
                        setStudentName(response.name || name);
                        setStudentId(response.studentId || id);
                    } else {
                        // Local authentication
                        setStudentName(name);
                        setStudentId(id);
                    }
                    setLoggedIn(true);
                } catch (error) {
                    console.error('Login failed:', error);
                    // Fallback to local login
                    setStudentName(name);
                    setStudentId(id);
                    setLoggedIn(true);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div id="auth">
                    <div className="card">
                        <h2>Login to Tutorly</h2>
                        <input
                            type="text"
                            placeholder="Student Name"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                        />
                        <input
                            type="text"
                            placeholder="Student ID"
                            value={id}
                            onChange={(e) => setId(e.target.value)}
                        />
                        <button onClick={login} disabled={isLoading}>
                            {isLoading ? 'Logging in...' : 'Login'}
                        </button>
                        {msg && <p className="error-msg">{msg}</p>}
                    </div>
                </div>
            );
        }

        // Enhanced Assignments Component with API
        function Assignments({ studentId, apiConfig }) {
            const [assignments, setAssignments] = useState([]);
            const [title, setTitle] = useState('');
            const [subject, setSubject] = useState('');
            const [due, setDue] = useState('');
            const [status, setStatus] = useState('Pending');
            const [difficulty, setDifficulty] = useState('Medium');
            const [score, setScore] = useState('');
            const [search, setSearch] = useState('');
            const [filterStatus, setFilterStatus] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const apiService = new APIService(apiConfig.backendUrl);

            useEffect(() => {
                loadAssignments();
            }, [studentId]);

            const loadAssignments = async () => {
                if (!apiConfig.backendUrl || !studentId) {
                    // Load from localStorage as fallback
                    const saved = localStorage.getItem(`assignments_${studentId}`);
                    if (saved) {
                        setAssignments(JSON.parse(saved));
                    }
                    return;
                }

                try {
                    setIsLoading(true);
                    const data = await apiService.getAssignments(studentId);
                    setAssignments(data);
                } catch (error) {
                    console.error('Failed to load assignments:', error);
                    const saved = localStorage.getItem(`assignments_${studentId}`);
                    if (saved) {
                        setAssignments(JSON.parse(saved));
                    }
                } finally {
                    setIsLoading(false);
                }
            };

            const saveAssignments = (newAssignments) => {
                localStorage.setItem(`assignments_${studentId}`, JSON.stringify(newAssignments));
                setAssignments(newAssignments);
            };

            const addAssignment = async () => {
                if (!title.trim() || !subject || !due) return;

                const newAssignment = {
                    title, subject, due, status, difficulty, score,
                    id: Date.now(),
                    createdAt: new Date().toISOString()
                };

                try {
                    if (apiConfig.backendUrl && studentId) {
                        const saved = await apiService.createAssignment(studentId, newAssignment);
                        saveAssignments([...assignments, saved]);
                    } else {
                        saveAssignments([...assignments, newAssignment]);
                    }
                    
                    // Reset form
                    setTitle(''); setSubject(''); setDue(''); 
                    setStatus('Pending'); setDifficulty('Medium'); setScore('');
                } catch (error) {
                    console.error('Failed to add assignment:', error);
                    saveAssignments([...assignments, newAssignment]);
                    setTitle(''); setSubject(''); setDue(''); 
                    setStatus('Pending'); setDifficulty('Medium'); setScore('');
                }
            };

            const removeAssignment = async (index) => {
                const assignment = assignments[index];

                try {
                    if (apiConfig.backendUrl && assignment.id) {
                        await apiService.deleteAssignment(assignment.id);
                    }
                    const newAssignments = assignments.filter((_, i) => i !== index);
                    saveAssignments(newAssignments);
                } catch (error) {
                    console.error('Failed to delete assignment:', error);
                    const newAssignments = assignments.filter((_, i) => i !== index);
                    saveAssignments(newAssignments);
                }
            };

            const filteredAssignments = assignments.filter((a) =>
                a.title.toLowerCase().includes(search.toLowerCase()) &&
                (filterStatus === '' || a.status === filterStatus)
            );

            return (
                <div style={{ padding: '1.5rem' }}>
                    <h2>Assignment Database {isLoading && <span style={{ fontSize: '0.8em', color: '#6b7280' }}>Loading...</span>}</h2>

                    <div style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                        <input
                            type="text"
                            placeholder="Search assignments..."
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                            style={{ flex: '1 1 200px' }}
                        />
                        <select
                            value={filterStatus}
                            onChange={(e) => setFilterStatus(e.target.value)}
                            style={{ flex: '0 0 150px' }}
                        >
                            <option value="">All Statuses</option>
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                    </div>

                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                        <input
                            type="text"
                            placeholder="Assignment Title"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            style={{ flex: '1 1 150px' }}
                        />
                        <input
                            type="text"
                            placeholder="Subject"
                            value={subject}
                            onChange={(e) => setSubject(e.target.value)}
                            style={{ flex: '1 1 120px' }}
                        />
                        <input
                            type="date"
                            value={due}
                            onChange={(e) => setDue(e.target.value)}
                            style={{ flex: '1 1 150px' }}
                        />
                        <select
                            value={status}
                            onChange={(e) => setStatus(e.target.value)}
                            style={{ flex: '1 1 120px' }}
                        >
                            <option>Pending</option>
                            <option>In Progress</option>
                            <option>Completed</option>
                            <option>Overdue</option>
                        </select>
                        <select
                            value={difficulty}
                            onChange={(e) => setDifficulty(e.target.value)}
                            style={{ flex: '1 1 100px' }}
                        >
                            <option>Easy</option>
                            <option>Medium</option>
                            <option>Hard</option>
                        </select>
                        <input
                            type="number"
                            placeholder="Score"
                            value={score}
                            onChange={(e) => setScore(e.target.value)}
                            style={{ flex: '1 1 80px' }}
                        />
                        <button onClick={addAssignment} className="btn-primary" disabled={isLoading}>
                            Add
                        </button>
                    </div>

                    {filteredAssignments.length === 0 ? (
                        <p style={{ color: '#6b7280' }}>No assignments found.</p>
                    ) : (
                        <div style={{ backgroundColor: 'white', borderRadius: '0.5rem', padding: '1rem', overflowX: 'auto' }}>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Assignment</th>
                                        <th>Subject</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Difficulty</th>
                                        <th>Score</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredAssignments.map((a, i) => (
                                        <tr key={a.id || i}>
                                            <td>{a.title}</td>
                                            <td>{a.subject}</td>
                                            <td>{a.due}</td>
                                            <td>{a.status}</td>
                                            <td>{a.difficulty}</td>
                                            <td>{a.score}</td>
                                            <td>
                                                <button
                                                    onClick={() => removeAssignment(i)}
                                                    style={{ color: '#dc2626', background: 'none', border: 'none', cursor: 'pointer' }}
                                                >
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        }

        // Main App Component with API Configuration
        function App() {
            const [studentName, setStudentName] = useState('');
            const [studentId, setStudentId] = useState('');
            const [loggedIn, setLoggedIn] = useState(false);
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [tab, setTab] = useState('ai-tutor');
            const [apiConfig, setApiConfig] = useState({
                geminiApiKey: '',
                backendUrl: 'http://localhost:5000/api' // Default Flask backend
            });

            // Load API config from localStorage
            useEffect(() => {
                const savedConfig = localStorage.getItem('tutorly_api_config');
                if (savedConfig) {
                    setApiConfig(JSON.parse(savedConfig));
                }
            }, []);

            // Simple routing
            useEffect(() => {
                const handleHashChange = () => {
                    const hash = window.location.hash.slice(1);
                    if (hash === 'ai-tutor') {
                        setCurrentPage('ai-tutor');
                    } else {
                        setCurrentPage('dashboard');
                    }
                };

                window.addEventListener('hashchange', handleHashChange);
                handleHashChange();

                return () => window.removeEventListener('hashchange', handleHashChange);
            }, []);

            if (!loggedIn) {
                return (
                    <div>
                        <APISettings apiConfig={apiConfig} setApiConfig={setApiConfig} />
                        <Auth
                            setStudentName={setStudentName}
                            setStudentId={setStudentId}
                            setLoggedIn={setLoggedIn}
                            apiConfig={apiConfig}
                        />
                    </div>
                );
            }

            return (
                <div>
                    {/* Navbar */}
                    <nav className="navbar">
                        <div className="logo-section">
                            <div style={{ 
                                width: '48px', 
                                height: '48px', 
                                backgroundColor: '#2563eb', 
                                borderRadius: '0.5rem', 
                                display: 'flex', 
                                alignItems: 'center', 
                                justifyContent: 'center', 
                                color: 'white', 
                                fontWeight: 'bold' 
                            }}>
                                T
                            </div>
                            <span style={{ fontWeight: 'bold', fontSize: '1.125rem' }}>Tutorly</span>
                        </div>
                        <div className="nav-links">
                            <a 
                                href="#" 
                                className={currentPage === 'dashboard' ? 'active' : ''} 
                                onClick={(e) => { e.preventDefault(); window.location.hash = ''; }}
                            >
                                Dashboard
                            </a>
                            <a 
                                href="#ai-tutor" 
                                className={currentPage === 'ai-tutor' ? 'active' : ''}
                            >
                                AI Tutor
                            </a>
                        </div>
                        <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>
                            {studentName}
                        </div>
                    </nav>

                    {/* API Settings (always visible when logged in) */}
                    <div style={{ padding: '0 1.5rem' }}>
                        <APISettings apiConfig={apiConfig} setApiConfig={setApiConfig} />
                    </div>

                    {currentPage === 'ai-tutor' ? (
                        <div>
                            <div className="secondary-nav">
                                {['ai-tutor', 'calendar'].map((item) => (
                                    <button
                                        key={item}
                                        onClick={() => setTab(item)}
                                        className={tab === item ? 'active-tab' : ''}
                                    >
                                        {item === 'ai-tutor' ? 'AI Tutor' : item.charAt(0).toUpperCase() + item.slice(1)}
                                    </button>
                                ))}
                            </div>

                            <div className="main-content">
                                {tab === 'ai-tutor' && (
                                    <ChatbotPage
                                        setLoggedIn={setLoggedIn}
                                        setStudentName={setStudentName}
                                        setStudentId={setStudentId}
                                        studentId={studentId}
                                        apiConfig={apiConfig}
                                    />
                                )}

                                {tab === 'todo' && (
                                    <div className="card">
                                        <TodoList studentId={studentId} apiConfig={apiConfig} />
                                    </div>
                                )}

                                {tab === 'calendar' && (
                                    <div className="card">
                                        <Assignments studentId={studentId} apiConfig={apiConfig} />
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : (
                        <div className="main-content">
                            <div style={{ textAlign: 'center', padding: '3rem 1rem' }}>
                                <h1>Welcome back, {studentName}!</h1>
                                <p>Ready to continue your learning journey?</p>
                                <button 
                                    style={{ 
                                        backgroundColor: '#000', 
                                        color: '#fff', 
                                        padding: '0.5rem 1.5rem', 
                                        borderRadius: '0.5rem', 
                                        border: 'none', 
                                        cursor: 'pointer', 
                                        marginTop: '1rem' 
                                    }}
                                    onClick={() => window.location.hash = 'ai-tutor'}
                                >
                                    Go to AI Tutor
                                </button>
                            </div>

                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1rem', padding: '0 1.5rem' }}>
                                <div className="card">
                                    <h3>Assignment Management</h3>
                                    <Assignments studentId={studentId} apiConfig={apiConfig} />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>